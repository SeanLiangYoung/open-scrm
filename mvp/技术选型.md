# SCRM系统技术选型与架构设计

**Technical Stack Selection and Architecture Design**

---

## 文档信息

| 项目信息 | 详情 |
|---------|------|
| **项目名称** | 企业SCRM私域运营系统 |
| **文档版本** | v1.0 |
| **创建日期** | 2025-10-27 |
| **文档状态** | 草案 |
| **技术负责人** | 待定 |
| **技术栈核心** | Node.js + Vue3 + UniApp |

---

## 目录

1. [系统模块架构](#1-系统模块架构)
2. [技术选型方案](#2-技术选型方案)
3. [框架设计](#3-框架设计)
4. [数据库设计](#4-数据库设计)
5. [部署架构](#5-部署架构)
6. [开发规范](#6-开发规范)
7. [附录](#7-附录)

---

## 1. 系统模块架构

### 1.1 整体系统架构

#### 1.1.1 系统划分

根据需求规格说明书和用户角色,系统划分为以下核心模块:

```
SCRM系统整体架构
├── 前端应用层
│   ├── 官方网站 (产品宣传)
│   ├── 企业管理平台 (企业管理者/IT管理员)
│   ├── 数据分析与BI平台 (企业管理者/市场人员)
│   ├── 对客运营平台 (运营/销售/市场人员)
│   ├── SaaS运营管理平台 (平台运营人员)
│   ├── 财务管理平台 (财务人员)
│   └── 移动端应用 (小程序/H5/App)
│
├── 后端服务层
│   ├── 网关服务
│   ├── 用户权限服务
│   ├── 获客服务
│   ├── 客户运营服务
│   ├── 客户资产服务
│   ├── 数据分析服务
│   ├── 第三方集成服务
│   ├── 消息推送服务
│   └── 财务结算服务
│
├── 数据存储层
│   ├── MySQL (主数据库)
│   ├── Redis (缓存)
│   ├── MongoDB (日志/消息)
│   └── OSS (文件存储)
│
└── 基础设施层
    ├── 监控告警
    ├── 日志收集
    ├── 任务调度
    └── CI/CD
```

---

### 1.2 各平台模块详细划分

#### 1.2.1 官方网站 (Official Website)

**目标用户:** 潜在客户、访客

**核心功能:**
- 产品介绍与功能展示
- 解决方案展示
- 客户案例展示
- 价格套餐展示
- 在线咨询与留资
- 博客/资讯
- 帮助文档

**技术选型:**
- 框架: Nuxt 4 (Vue3 + SSR)
- UI: 自定义组件 + TailwindCSS
- 渲染: SSR/SSG (SEO优化)
- 部署: Vercel / 阿里云OSS + CDN

---

#### 1.2.2 企业管理平台 (Admin Platform)

**目标用户:** 企业管理者、IT管理员

**核心模块:**

| 模块名称 | 功能说明 | 优先级 |
|---------|---------|--------|
| **企业管理** | 企业信息、部门管理、员工管理 | P0 |
| **权限管理** | 角色管理、权限配置、数据权限 | P0 |
| **系统配置** | 基础配置、第三方集成配置 | P0 |
| **账号管理** | 平台账号、渠道账号绑定 | P0 |
| **套餐管理** | 套餐升级、功能开通 | P1 |
| **账单中心** | 费用查询、发票管理 | P1 |
| **操作日志** | 审计日志、操作记录 | P1 |

**技术选型:**
- 框架: Vue3 + Vite
- UI: Element Plus
- 状态管理: Pinia
- 路由: Vue Router
- 请求: Axios

---

#### 1.2.3 数据分析与BI平台 (BI Platform)

**目标用户:** 企业管理者、市场人员

**核心模块:**

| 模块名称 | 功能说明 | 优先级 |
|---------|---------|--------|
| **数据概览** | 核心指标大盘、实时数据 | P0 |
| **获客分析** | 渠道分析、内容分析、成本分析 | P0 |
| **运营分析** | 客户分析、SOP分析、社群分析 | P0 |
| **转化分析** | 转化漏斗、ROI分析、LTV分析 | P0 |
| **自定义报表** | 报表配置、报表导出 | P1 |
| **数据预测** | 趋势预测、智能洞察 | P2 |

**技术选型:**
- 框架: Vue3 + Vite
- UI: Element Plus / Ant Design Vue
- 图表: ECharts / Apache ECharts
- 数据可视化: DataV (可选)
- 状态管理: Pinia

---

#### 1.2.4 对客运营平台 (Operation Platform)

**目标用户:** 运营人员、销售人员、市场人员

**核心模块:**

| 模块名称 | 功能说明 | 优先级 |
|---------|---------|--------|
| **获客管理** | 抖音/小红书内容发布、渠道管理 | P0 |
| **客户管理** | 客户列表、客户画像、客户跟进 | P0 |
| **SOP管理** | SOP配置、SOP执行、任务管理 | P0 |
| **社群管理** | 群管理、群SOP、群活动 | P0 |
| **标签管理** | 标签配置、自动打标 | P0 |
| **消息群发** | 批量群发、定向推送 | P0 |
| **海报生成** | 海报模板、一键生成 | P0 |
| **门店管理** | 门店管理、活动管理 | P0 |
| **素材库** | 图片、视频、文案素材 | P1 |
| **数据看板** | 个人数据、团队数据 | P1 |

**技术选型:**
- 框架: Vue3 + Vite
- UI: Element Plus
- 状态管理: Pinia
- 图表: ECharts
- 富文本编辑器: WangEditor / TinyMCE
- 图片处理: Fabric.js (海报生成)

---

#### 1.2.5 SaaS运营管理平台 (SaaS Admin Platform)

**目标用户:** 平台运营人员、超级管理员

**核心模块:**

| 模块名称 | 功能说明 | 优先级 |
|---------|---------|--------|
| **租户管理** | 企业租户列表、租户配置 | P0 |
| **套餐管理** | 套餐定义、功能权限配置 | P0 |
| **订单管理** | 订单列表、订单处理 | P0 |
| **系统监控** | 服务监控、性能监控 | P0 |
| **数据统计** | 平台数据、租户数据 | P0 |
| **工单管理** | 工单处理、问题跟踪 | P1 |
| **公告管理** | 系统公告、版本更新 | P1 |
| **模板市场** | SOP模板、海报模板管理 | P2 |

**技术选型:**
- 框架: Vue3 + Vite
- UI: Ant Design Vue
- 状态管理: Pinia
- 图表: ECharts

---

#### 1.2.6 财务管理平台 (Finance Platform)

**目标用户:** 财务人员

**核心模块:**

| 模块名称 | 功能说明 | 优先级 |
|---------|---------|--------|
| **订单管理** | 订单列表、订单详情 | P0 |
| **收款管理** | 收款记录、对账管理 | P0 |
| **发票管理** | 发票开具、发票记录 | P0 |
| **财务报表** | 收入报表、成本报表 | P0 |
| **结算管理** | 供应商结算、佣金结算 | P1 |
| **对账中心** | 平台对账、异常处理 | P1 |

**技术选型:**
- 框架: Vue3 + Vite
- UI: Element Plus
- 状态管理: Pinia
- 图表: ECharts
- 表格: vxe-table (复杂表格)

---

#### 1.2.7 移动端应用 (Mobile App)

**目标用户:** 运营/销售人员(移动办公)

**核心模块:**

| 模块名称 | 功能说明 | 优先级 |
|---------|---------|--------|
| **工作台** | 待办任务、快捷入口 | P0 |
| **客户管理** | 客户列表、客户详情、快速跟进 | P0 |
| **消息通知** | 系统通知、任务提醒 | P0 |
| **SOP执行** | 待执行任务、执行记录 | P0 |
| **数据看板** | 个人数据、实时更新 | P1 |
| **朋友圈** | 朋友圈素材、一键发布 | P1 |

**技术选型:**
- 框架: UniApp (Vue3)
- UI: NutUI (京东开源,跨端支持好)
- 状态管理: Pinia
- 多端支持: 微信小程序、H5、App(iOS/Android)

---

### 1.3 模块间关系

**微服务架构全景图:**

```
┌────────────────────────────────────────────────────────────────┐
│                     前端应用层(多平台)                          │
├────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐      │
│  │官方网站  │  │管理平台  │  │BI平台    │  │运营平台  │      │
│  │(Nuxt4)   │  │(Vue3)    │  │(Vue3)    │  │(Vue3)    │      │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘      │
│                                                                  │
│  ┌──────────┐  ┌──────────┐  ┌──────────────────────┐        │
│  │SaaS平台  │  │财务平台  │  │移动端(UniApp+NutUI)  │        │
│  │(Vue3)    │  │(Vue3)    │  │小程序/H5/App         │        │
│  └──────────┘  └──────────┘  └──────────────────────┘        │
│                                                                  │
└────────────────────────────────────────────────────────────────┘
                               ↓ HTTPS
┌────────────────────────────────────────────────────────────────┐
│                   API Gateway (网关服务)                        │
│  ┌────────────────────────────────────────────────────────┐   │
│  │  - 路由转发    - 认证鉴权    - 限流熔断                │   │
│  │  - 负载均衡    - 日志记录    - 监控追踪                │   │
│  └────────────────────────────────────────────────────────┘   │
└────────────────────────────────────────────────────────────────┘
          ↓ HTTP/RPC                ↓ HTTP/RPC            ↓ HTTP/RPC
┌────────────────────────────────────────────────────────────────┐
│                    微服务层(Midway.js)                          │
│                                                                  │
│  ┌────────────┐  ┌────────────┐  ┌────────────┐               │
│  │  认证服务  │  │  获客服务  │  │  客户服务  │               │
│  │ (Auth)     │  │(Acquisition)│  │(Customer)  │               │
│  └────────────┘  └────────────┘  └────────────┘               │
│         ↕ RPC           ↕ MQ            ↕ HTTP/RPC              │
│  ┌────────────┐  ┌────────────┐  ┌────────────┐               │
│  │  运营服务  │  │  资产服务  │  │  分析服务  │               │
│  │(Operation) │  │  (Asset)   │  │(Analytics) │               │
│  └────────────┘  └────────────┘  └────────────┘               │
│         ↕ MQ            ↕ HTTP           ↕ RPC                  │
│  ┌────────────┐  ┌────────────┐  ┌────────────┐               │
│  │  集成服务  │  │  消息服务  │  │  财务服务  │               │
│  │(Integration)│  │ (Message)  │  │ (Finance)  │               │
│  └────────────┘  └────────────┘  └────────────┘               │
│                                                                  │
└────────────────────────────────────────────────────────────────┘
          ↓                      ↓                       ↓
┌────────────────────────────────────────────────────────────────┐
│                      消息中间件层                                │
│  ┌──────────────────────────────────────────────────────┐     │
│  │  RabbitMQ (事件总线 + 异步任务)                      │     │
│  │  - 客户事件 - SOP任务 - 数据同步 - 消息推送          │     │
│  └──────────────────────────────────────────────────────┘     │
└────────────────────────────────────────────────────────────────┘
          ↓                      ↓                       ↓
┌────────────────────────────────────────────────────────────────┐
│                       数据存储层                                 │
│  ┌────────────┐  ┌────────────┐  ┌────────────┐               │
│  │   MySQL    │  │   Redis    │  │  MongoDB   │               │
│  │  (主数据)  │  │  (缓存)    │  │ (日志/消息)│               │
│  └────────────┘  └────────────┘  └────────────┘               │
│                                                                  │
│  ┌────────────┐  ┌────────────────────────────────┐           │
│  │    OSS     │  │      ElasticSearch             │           │
│  │ (文件存储) │  │   (搜索引擎-可选)              │           │
│  └────────────┘  └────────────────────────────────┘           │
└────────────────────────────────────────────────────────────────┘

**通信方式说明:**
- HTTP: 同步调用,适合查询类操作
- RPC (gRPC): 高性能同步调用,适合内部服务调用
- MQ: 异步消息,适合事件通知和异步任务
- Feign: 声明式HTTP客户端,简化服务间调用
```

---

## 2. 技术选型方案

### 2.1 前端技术栈

#### 2.1.1 核心框架

**Vue3 生态选择理由:**
- ✅ 渐进式框架,易学易用
- ✅ 响应式系统优秀,性能好
- ✅ Composition API灵活
- ✅ 社区活跃,生态丰富
- ✅ TypeScript支持好

**技术选型:**

| 技术 | 版本 | 用途 | 说明 |
|------|------|------|------|
| **Vue** | 3.3+ | 核心框架 | 使用Composition API |
| **Vite** | 4.x+ | 构建工具 | 快速开发,HMR优秀 |
| **TypeScript** | 5.x | 类型系统 | 提升代码质量 |
| **Pinia** | 2.x | 状态管理 | Vue3官方推荐 |
| **Vue Router** | 4.x | 路由管理 | 官方路由 |
| **Axios** | 1.x | HTTP请求 | 请求拦截、响应处理 |

#### 2.1.2 UI组件库

**多平台UI选择:**

| 平台 | UI库 | 版本 | 选择理由 |
|------|------|------|---------|
| **管理平台** | Element Plus | 2.x | 组件丰富、文档完善 |
| **BI平台** | Element Plus | 2.x | 数据展示组件好 |
| **运营平台** | Element Plus | 2.x | 统一UI风格 |
| **SaaS平台** | Ant Design Vue | 4.x | 企业级UI |
| **财务平台** | Element Plus | 2.x | 表格组件强大 |
| **移动端** | NutUI | 4.x | 京东开源,跨端支持好 |
| **官网** | 自定义 + TailwindCSS | - | 定制化设计 |

#### 2.1.3 图表可视化

| 库名称 | 版本 | 用途 | 说明 |
|--------|------|------|------|
| **ECharts** | 5.x | 数据图表 | 功能强大、图表类型丰富 |
| **vue-echarts** | 6.x | Vue集成 | ECharts的Vue封装 |
| **Fabric.js** | 5.x | Canvas绘图 | 海报生成 |
| **html2canvas** | 1.x | 截图 | 页面转图片 |

#### 2.1.4 富文本编辑器

| 编辑器 | 版本 | 用途 | 说明 |
|--------|------|------|------|
| **WangEditor** | 5.x | 内容编辑 | 轻量、易用 |
| **Quill** | 2.x | 备选 | 模块化、可扩展 |

#### 2.1.5 其他工具库

| 库名称 | 用途 | 说明 |
|--------|------|------|
| **dayjs** | 日期处理 | 轻量级日期库 |
| **lodash-es** | 工具函数 | ES模块版本 |
| **vxe-table** | 复杂表格 | 虚拟滚动、编辑 |
| **v-md-editor** | Markdown | 文档编辑 |
| **qrcode** | 二维码生成 | 活码生成 |

---

### 2.2 后端技术栈

#### 2.2.1 核心框架

**Midway.js 选择理由:**
- ✅ 基于TypeScript,类型安全
- ✅ 依赖注入,代码解耦
- ✅ 装饰器语法,开发效率高
- ✅ 集成度高,开箱即用
- ✅ 支持Serverless部署
- ✅ 阿里开源,社区活跃

**技术选型:**

| 技术 | 版本 | 用途 | 说明 |
|------|------|------|------|
| **Midway** | 3.x | 应用框架 | 核心框架 |
| **Node.js** | 18 LTS | 运行环境 | 长期支持版本 |
| **TypeScript** | 5.x | 开发语言 | 类型安全 |
| **@midwayjs/web** | 3.x | Web层 | 基于Koa |
| **@midwayjs/typeorm** | 3.x | ORM | 数据库操作 |
| **@midwayjs/redis** | 3.x | 缓存 | Redis集成 |
| **@midwayjs/jwt** | 3.x | 认证 | JWT鉴权 |
| **@midwayjs/validate** | 3.x | 验证 | 参数校验 |

#### 2.2.2 数据库相关

**MySQL + TypeORM:**

| 技术 | 版本 | 用途 | 说明 |
|------|------|------|------|
| **MySQL** | 8.0 | 主数据库 | 关系型数据库 |
| **TypeORM** | 0.3.x | ORM框架 | Entity管理 |
| **mysql2** | 3.x | 驱动 | MySQL驱动 |

**Redis:**

| 技术 | 版本 | 用途 | 说明 |
|------|------|------|------|
| **Redis** | 7.0 | 缓存 | 内存数据库 |
| **ioredis** | 5.x | Redis客户端 | 功能丰富 |

**MongoDB:**

| 技术 | 版本 | 用途 | 说明 |
|------|------|------|------|
| **MongoDB** | 6.0 | 文档数据库 | 日志、消息存储 |
| **mongoose** | 7.x | ODM | 对象文档映射 |

#### 2.2.3 消息队列

| 技术 | 版本 | 用途 | 说明 |
|------|------|------|------|
| **RabbitMQ** | 3.x | 消息队列 | 异步任务 |
| **Bull** | 4.x | 任务队列 | 基于Redis |
| **@midwayjs/bull** | 3.x | Bull集成 | Midway插件 |

#### 2.2.4 任务调度

| 技术 | 版本 | 用途 | 说明 |
|------|------|------|------|
| **node-cron** | 3.x | 定时任务 | Cron表达式 |
| **@midwayjs/task** | 3.x | 任务调度 | Midway集成 |

#### 2.2.5 文件处理

| 技术 | 版本 | 用途 | 说明 |
|------|------|------|------|
| **@midwayjs/oss** | 3.x | 对象存储 | 阿里云OSS |
| **@midwayjs/upload** | 3.x | 文件上传 | Midway插件 |
| **sharp** | 0.32.x | 图片处理 | 压缩、裁剪 |

#### 2.2.6 日志监控

| 技术 | 版本 | 用途 | 说明 |
|------|------|------|------|
| **winston** | 3.x | 日志 | 日志记录 |
| **@midwayjs/logger** | 3.x | 日志集成 | Midway日志 |
| **prom-client** | 14.x | 监控 | Prometheus客户端 |

#### 2.2.7 API文档

| 技术 | 版本 | 用途 | 说明 |
|------|------|------|------|
| **@midwayjs/swagger** | 3.x | API文档 | Swagger集成 |
| **swagger-ui-dist** | 5.x | UI | Swagger UI |

---

### 2.3 移动端技术栈 (UniApp)

#### 2.3.1 核心框架

**UniApp 选择理由:**
- ✅ 一套代码,多端运行
- ✅ Vue3语法,学习成本低
- ✅ 组件丰富,开发效率高
- ✅ 社区活跃,插件丰富
- ✅ HBuilderX IDE强大

**技术选型:**

| 技术 | 版本 | 用途 | 说明 |
|------|------|------|------|
| **UniApp** | 3.x | 跨端框架 | Vue3版本 |
| **Vue** | 3.x | 核心框架 | Composition API |
| **TypeScript** | 5.x | 开发语言 | 类型支持 |
| **Pinia** | 2.x | 状态管理 | 跨端状态 |
| **NutUI** | 4.x | UI组件库 | 京东开源,跨端支持好 |

**NutUI 选择理由:**
- ✅ 京东开源,维护活跃
- ✅ 完美支持 Vue3 + TypeScript
- ✅ 跨端支持好(H5/小程序/App)
- ✅ 组件丰富(80+组件)
- ✅ 文档完善,上手简单
- ✅ 主题定制能力强

#### 2.3.2 插件与工具

| 插件 | 用途 | 说明 |
|------|------|------|
| **uni-network** | 网络请求 | 统一请求封装 |
| **uni-simple-router** | 路由管理 | 增强路由 |
| **z-paging** | 分页加载 | 下拉刷新 |
| **lime-echart** | 图表 | ECharts适配 |

---

### 2.4 第三方服务集成

#### 2.4.1 必须集成

| 服务 | SDK | 用途 | 说明 |
|------|-----|------|------|
| **企业微信** | @wecom/jssdk | 企微集成 | 官方SDK |
| **抖音开放平台** | douyin-open-api | 抖音集成 | 内容发布 |
| **小红书开放平台** | xiaohongshu-api | 小红书集成 | 内容发布 |

#### 2.4.2 可选集成

| 服务 | SDK | 用途 | 说明 |
|------|-----|------|------|
| **微信支付** | wechatpay-axios-plugin | 支付 | 官方SDK |
| **支付宝支付** | alipay-sdk | 支付 | 官方SDK |
| **阿里云短信** | @alicloud/dysmsapi20170525 | 短信 | 验证码 |
| **阿里云OSS** | ali-oss | 存储 | 文件存储 |

---

### 2.5 开发工具与环境

#### 2.5.1 开发工具

| 工具 | 用途 | 说明 |
|------|------|------|
| **VS Code** | 代码编辑 | 主力IDE |
| **HBuilderX** | UniApp开发 | 官方IDE |
| **Postman** | API测试 | 接口调试 |
| **Navicat** | 数据库管理 | MySQL/MongoDB |
| **Redis Desktop Manager** | Redis管理 | 缓存管理 |

#### 2.5.2 VS Code 插件推荐

| 插件 | 用途 |
|------|------|
| **Volar** | Vue3支持 |
| **TypeScript Vue Plugin** | Vue TS支持 |
| **ESLint** | 代码检查 |
| **Prettier** | 代码格式化 |
| **GitLens** | Git增强 |
| **Thunder Client** | API测试 |

#### 2.5.3 开发环境

| 环境 | 版本要求 | 说明 |
|------|---------|------|
| **Node.js** | 18.x LTS | 运行环境 |
| **pnpm** | 8.x | 包管理器 |
| **MySQL** | 8.0 | 开发数据库 |
| **Redis** | 7.0 | 开发缓存 |
| **MongoDB** | 6.0 | 开发文档库 |

---

## 3. 框架设计

### 3.1 项目结构设计

#### 3.1.1 Monorepo 架构

**使用pnpm workspace管理多包:**

```
scrm-system/
├── apps/                       # 应用层 (独立工程)
│   ├── official-website/       # 官方网站 (Nuxt 4)
│   │   ├── app/                # Nuxt 4 app目录
│   │   ├── pages/              # 页面
│   │   ├── components/         # 组件
│   │   ├── composables/        # hooks
│   │   ├── server/             # 服务端
│   │   ├── public/             # 静态资源
│   │   ├── nuxt.config.ts      # Nuxt配置
│   │   └── package.json
│   │
│   ├── admin-platform/         # 管理平台 (Vue3 + Vite)
│   │   ├── src/
│   │   │   ├── components/
│   │   │   ├── composables/    # hooks
│   │   │   ├── views/
│   │   │   ├── router/
│   │   │   ├── stores/
│   │   │   └── main.ts
│   │   ├── vite.config.ts
│   │   └── package.json
│   │
│   ├── bi-platform/            # BI分析平台 (Vue3 + Vite)
│   │   └── ...
│   │
│   ├── operation-platform/     # 运营平台 (Vue3 + Vite)
│   │   └── ...
│   │
│   ├── saas-admin/             # SaaS管理平台 (Vue3 + Vite)
│   │   └── ...
│   │
│   ├── finance-platform/       # 财务平台 (Vue3 + Vite)
│   │   └── ...
│   │
│   └── mobile-app/             # 移动端 (UniApp + NutUI)
│       ├── src/
│       │   ├── pages/
│       │   ├── components/
│       │   ├── composables/
│       │   ├── stores/
│       │   └── main.ts
│       ├── manifest.json
│       └── package.json
│
├── services/                   # 后端微服务
│   ├── gateway-service/        # 网关服务 (Midway)
│   │   ├── src/
│   │   │   ├── config/
│   │   │   ├── middleware/
│   │   │   ├── filter/
│   │   │   └── configuration.ts
│   │   └── package.json
│   │
│   ├── auth-service/           # 认证授权服务 (Midway)
│   │   ├── src/
│   │   │   ├── controller/
│   │   │   ├── service/
│   │   │   ├── entity/
│   │   │   └── dto/
│   │   └── package.json
│   │
│   ├── customer-service/       # 客户管理服务 (Midway)
│   │   └── ...
│   │
│   ├── acquisition-service/    # 获客服务 (Midway)
│   │   └── ...
│   │
│   ├── operation-service/      # 运营服务 (Midway)
│   │   └── ...
│   │
│   ├── asset-service/          # 资产管理服务 (Midway)
│   │   └── ...
│   │
│   ├── analytics-service/      # 数据分析服务 (Midway)
│   │   └── ...
│   │
│   ├── integration-service/    # 第三方集成服务 (Midway)
│   │   └── ...
│   │
│   ├── message-service/        # 消息推送服务 (Midway)
│   │   └── ...
│   │
│   └── finance-service/        # 财务服务 (Midway)
│       └── ...
│
├── packages/                   # 共享包
│   ├── shared-types/           # 共享类型定义
│   │   ├── src/
│   │   │   ├── api.ts          # API类型
│   │   │   ├── models.ts       # 数据模型
│   │   │   └── index.ts
│   │   └── package.json
│   │
│   ├── shared-utils/           # 共享工具函数
│   │   ├── src/
│   │   │   ├── format.ts
│   │   │   ├── validate.ts
│   │   │   ├── request.ts
│   │   │   └── index.ts
│   │   └── package.json
│   │
│   ├── shared-constants/       # 共享常量
│   │   ├── src/
│   │   │   ├── enums.ts
│   │   │   ├── config.ts
│   │   │   └── index.ts
│   │   └── package.json
│   │
│   ├── ui-components/          # 共享UI组件 (Vue3)
│   │   ├── src/
│   │   │   ├── components/
│   │   │   │   ├── user-avatar/
│   │   │   │   ├── data-table/
│   │   │   │   └── ...
│   │   │   └── index.ts
│   │   └── package.json
│   │
│   └── server-common/          # 后端公共模块
│       ├── src/
│       │   ├── decorators/     # 公共装饰器
│       │   ├── filters/        # 公共过滤器
│       │   ├── interceptors/   # 公共拦截器
│       │   ├── utils/          # 公共工具
│       │   └── index.ts
│       └── package.json
│
├── scripts/                    # 脚本
│   ├── build.sh                # 构建脚本
│   ├── deploy.sh               # 部署脚本
│   └── init-db.sh              # 数据库初始化
│
├── docs/                       # 文档
│   ├── api/                    # API文档
│   ├── architecture/           # 架构文档
│   └── development/            # 开发文档
│
├── .github/                    # GitHub配置
│   └── workflows/              # CI/CD
│
├── pnpm-workspace.yaml         # workspace配置
├── package.json                # 根package.json
├── tsconfig.json               # TS配置
└── turbo.json                  # Turborepo配置 (可选)
```

**workspace配置 (pnpm-workspace.yaml):**
```yaml
packages:
  - 'apps/*'
  - 'services/*'
  - 'packages/*'
```

**根 package.json 脚本:**
```json
{
  "scripts": {
    "dev": "turbo run dev",
    "dev:web": "pnpm --filter \"./apps/**\" dev",
    "dev:service": "pnpm --filter \"./services/**\" dev",
    "build": "turbo run build",
    "build:web": "pnpm --filter \"./apps/**\" build",
    "build:service": "pnpm --filter \"./services/**\" build",
    "test": "turbo run test",
    "lint": "turbo run lint"
  }
}
```

---

#### 3.1.2 前端项目结构 (以运营平台为例)

```
operation-platform/             # kebab-case命名
├── src/
│   ├── api/                    # API接口 (kebab-case)
│   │   ├── index.ts
│   │   ├── customer-api.ts
│   │   ├── sop-api.ts
│   │   └── community-api.ts
│   │
│   ├── assets/                 # 静态资源
│   │   ├── images/
│   │   ├── styles/
│   │   │   ├── variables.css   # CSS变量
│   │   │   └── global.css      # 全局样式
│   │   └── fonts/
│   │
│   ├── components/             # 公共组件 (kebab-case)
│   │   ├── common/             # 通用组件
│   │   │   ├── user-avatar.vue
│   │   │   ├── data-table.vue
│   │   │   └── form-dialog.vue
│   │   ├── business/           # 业务组件
│   │   │   ├── customer-card.vue
│   │   │   ├── sop-timeline.vue
│   │   │   └── tag-selector.vue
│   │   └── layout/             # 布局组件
│   │       ├── main-layout.vue
│   │       ├── sidebar.vue
│   │       └── header.vue
│   │
│   ├── composables/            # Hooks (use-前缀, kebab-case)
│   │   ├── use-auth.ts         # 认证hook
│   │   ├── use-table.ts        # 表格hook
│   │   ├── use-customer.ts     # 客户管理hook
│   │   ├── use-sop.ts          # SOP hook
│   │   ├── use-pagination.ts   # 分页hook
│   │   └── use-request.ts      # 请求hook
│   │
│   ├── config/                 # 配置
│   │   ├── index.ts
│   │   └── app-config.ts
│   │
│   ├── directives/             # 自定义指令
│   │   ├── permission.ts
│   │   └── loading.ts
│   │
│   ├── layouts/                # 布局
│   │   ├── default-layout.vue
│   │   └── blank-layout.vue
│   │
│   ├── plugins/                # 插件
│   │   ├── element-plus.ts
│   │   └── echarts.ts
│   │
│   ├── router/                 # 路由
│   │   ├── index.ts
│   │   ├── routes.ts
│   │   └── guards.ts
│   │
│   ├── stores/                 # 状态管理(Pinia)
│   │   ├── index.ts
│   │   ├── user-store.ts       # kebab-case
│   │   ├── app-store.ts
│   │   └── customer-store.ts
│   │
│   ├── types/                  # 本地类型定义
│   │   └── env.d.ts
│   │
│   ├── utils/                  # 工具函数
│   │   ├── request-helper.ts
│   │   ├── storage-helper.ts
│   │   └── format-helper.ts
│   │
│   ├── views/                  # 页面 (kebab-case)
│   │   ├── dashboard/
│   │   │   └── index.vue
│   │   ├── customer/
│   │   │   ├── customer-list.vue
│   │   │   └── customer-detail.vue
│   │   ├── sop/
│   │   │   ├── sop-list.vue
│   │   │   └── sop-config.vue
│   │   └── community/
│   │       ├── community-list.vue
│   │       └── community-detail.vue
│   │
│   ├── app.vue                 # 根组件
│   └── main.ts                 # 入口文件
│
├── public/                     # 公共文件
├── index.html                  # HTML模板
├── vite.config.ts              # Vite配置
├── tsconfig.json               # TS配置
├── package.json                # 依赖
└── .env.development            # 环境变量
```

**Hooks使用示例:**
```typescript
// composables/use-customer.ts
import { ref, computed } from 'vue';
import type { Customer } from '@scrm/shared-types';
import * as customerApi from '@/api/customer-api';

export const useCustomer = () => {
  const customerList = ref<Customer[]>([]);
  const loading = ref(false);
  const total = ref(0);
  
  // 获取客户列表
  const fetchCustomers = async (params?: any) => {
    loading.value = true;
    try {
      const res = await customerApi.getCustomerList(params);
      customerList.value = res.data.list;
      total.value = res.data.total;
    } finally {
      loading.value = false;
    }
  };
  
  // 删除客户
  const deleteCustomer = async (id: number) => {
    await customerApi.deleteCustomer(id);
    await fetchCustomers();
  };
  
  return {
    customerList,
    loading,
    total,
    fetchCustomers,
    deleteCustomer,
  };
};

// 在组件中使用
// views/customer/customer-list.vue
<script setup lang="ts">
import { onMounted } from 'vue';
import { useCustomer } from '@/composables/use-customer';
import { usePagination } from '@/composables/use-pagination';

const { customerList, loading, fetchCustomers, deleteCustomer } = useCustomer();
const { page, size, handlePageChange } = usePagination({
  onPageChange: fetchCustomers
});

onMounted(() => {
  fetchCustomers({ page: page.value, size: size.value });
});
</script>
```

---

#### 3.1.3 后端微服务结构

**单个微服务结构 (以客户服务为例):**

```
customer-service/              # PascalCase命名的服务
├── src/
│   ├── config/                # 配置
│   │   ├── Config.ts          # 配置类 (PascalCase)
│   │   └── DataSource.ts      # 数据源配置
│   │
│   ├── controller/            # 控制器 (PascalCase)
│   │   ├── CustomerController.ts
│   │   ├── TagController.ts
│   │   └── index.ts
│   │
│   ├── service/               # 服务层 (PascalCase)
│   │   ├── CustomerService.ts
│   │   ├── TagService.ts
│   │   └── CustomerCacheService.ts
│   │
│   ├── entity/                # 实体 (PascalCase)
│   │   ├── CustomerEntity.ts
│   │   ├── TagEntity.ts
│   │   └── CustomerTagRelationEntity.ts
│   │
│   ├── dto/                   # DTO (PascalCase)
│   │   ├── CreateCustomerDto.ts
│   │   ├── UpdateCustomerDto.ts
│   │   └── CustomerQueryDto.ts
│   │
│   ├── vo/                    # 视图对象 (PascalCase)
│   │   ├── CustomerVo.ts
│   │   └── CustomerDetailVo.ts
│   │
│   ├── repository/            # 仓储层 (可选)
│   │   └── CustomerRepository.ts
│   │
│   ├── middleware/            # 中间件
│   │   └── AuthMiddleware.ts
│   │
│   ├── guard/                 # 守卫
│   │   └── PermissionGuard.ts
│   │
│   ├── filter/                # 过滤器
│   │   └── GlobalExceptionFilter.ts
│   │
│   ├── decorator/             # 装饰器
│   │   └── RequirePermission.ts
│   │
│   ├── interceptor/           # 拦截器
│   │   └── ResponseInterceptor.ts
│   │
│   ├── consumer/              # 消息消费者
│   │   ├── CustomerEventConsumer.ts
│   │   └── SopEventConsumer.ts
│   │
│   ├── producer/              # 消息生产者
│   │   └── CustomerEventProducer.ts
│   │
│   ├── client/                # RPC/HTTP客户端
│   │   ├── AuthServiceClient.ts      # 调用认证服务
│   │   ├── OperationServiceClient.ts # 调用运营服务
│   │   └── index.ts
│   │
│   ├── task/                  # 定时任务
│   │   └── CustomerStatsTask.ts
│   │
│   ├── utils/                 # 工具类
│   │   ├── CryptoUtil.ts
│   │   └── DateUtil.ts
│   │
│   ├── constant/              # 常量
│   │   └── CustomerConstant.ts
│   │
│   ├── Configuration.ts       # 配置类
│   └── Bootstrap.ts           # 启动文件
│
├── test/                      # 测试
│   ├── unit/                  # 单元测试
│   └── integration/           # 集成测试
│
├── logs/                      # 日志
├── package.json
├── tsconfig.json
├── .env
└── README.md
```

**微服务通信方式:**

```typescript
// 1. HTTP 调用 (通过网关)
// client/OperationServiceClient.ts
import { Inject, Provide } from '@midwayjs/core';
import { HttpService } from '@midwayjs/axios';

@Provide()
export class OperationServiceClient {
  @Inject()
  httpService: HttpService;
  
  // 通过网关调用运营服务
  async getSopList(customerId: number) {
    const response = await this.httpService.get(
      `${process.env.GATEWAY_URL}/api/v1/operation/sop-list`,
      { params: { customerId } }
    );
    return response.data;
  }
}

// 2. RPC 调用 (使用gRPC - 可选)
// client/AuthServiceClient.ts
import { Provide } from '@midwayjs/core';
import { GrpcClient } from '@midwayjs/grpc';

@Provide()
export class AuthServiceClient {
  @GrpcClient({
    package: 'auth',
    protoPath: 'proto/auth.proto',
    url: 'auth-service:50051',
  })
  authService: any;
  
  async validateToken(token: string) {
    return await this.authService.validateToken({ token });
  }
}

// 3. 消息队列 (异步通信)
// producer/CustomerEventProducer.ts
import { Inject, Provide } from '@midwayjs/core';
import { RabbitMQProducer } from '@midwayjs/rabbitmq';

@Provide()
export class CustomerEventProducer {
  @Inject()
  producer: RabbitMQProducer;
  
  // 发布客户创建事件
  async publishCustomerCreated(customer: any) {
    await this.producer.publish('customer.created', {
      exchange: 'scrm.events',
      routingKey: 'customer.created',
      message: customer,
    });
  }
}

// consumer/CustomerEventConsumer.ts
import { Provide } from '@midwayjs/core';
import { RabbitMQListener } from '@midwayjs/rabbitmq';

@Provide()
export class CustomerEventConsumer {
  @RabbitMQListener('customer.created', {
    exchange: 'scrm.events',
    routingKey: 'customer.created',
  })
  async handleCustomerCreated(message: any) {
    console.log('Customer created:', message);
    // 处理业务逻辑
  }
}

// 4. Feign风格HTTP客户端 (基于装饰器)
// client/AnalyticsServiceClient.ts
import { Provide } from '@midwayjs/core';
import { FeignClient, Get, Post, Body } from '@scrm/server-common';

@Provide()
@FeignClient({ 
  name: 'analytics-service',
  url: '${gateway.url}/api/v1/analytics'
})
export class AnalyticsServiceClient {
  
  @Get('/customer-stats/:id')
  async getCustomerStats(id: number): Promise<any> {
    // 自动实现
  }
  
  @Post('/record-behavior')
  async recordBehavior(@Body() data: any): Promise<void> {
    // 自动实现
  }
}
```

**服务间调用关系图:**

```
┌──────────────────────────────────────────────────┐
│              Gateway Service (网关)               │
│    - 路由转发                                     │
│    - 认证鉴权                                     │
│    - 限流熔断                                     │
└──────────────────────────────────────────────────┘
           ↓ HTTP                    ↓ HTTP
┌─────────────────────┐    ┌─────────────────────┐
│  Customer Service   │    │  Operation Service  │
│  (客户管理)         │    │  (客户运营)         │
│                     │←───│                     │
│  - HTTP调用         │ RPC│  - MQ消息          │
│  - RPC调用          │    │  - HTTP调用         │
└─────────────────────┘    └─────────────────────┘
           ↓ MQ                      ↓ MQ
┌──────────────────────────────────────────────────┐
│            Message Queue (RabbitMQ)               │
│    - 事件总线                                     │
│    - 异步任务                                     │
└──────────────────────────────────────────────────┘
           ↑ Subscribe               ↑ Subscribe
┌─────────────────────┐    ┌─────────────────────┐
│  Analytics Service  │    │  Message Service    │
│  (数据分析)         │    │  (消息推送)         │
└─────────────────────┘    └─────────────────────┘
```

---

### 3.2 代码规范设计

#### 3.2.1 命名规范

**前端命名规范 (kebab-case 优先):**
```
- 组件: kebab-case     user-profile.vue
- 页面: kebab-case     user-list.vue
- 工具: kebab-case     format-date.ts
- Hooks: use-前缀      use-customer.ts, use-table.ts
- 类型: kebab-case     user-info.ts
- 常量: UPPER_CASE     API_BASE_URL.ts
```

**前端代码风格:**
```typescript
// ✅ 推荐：使用 Composition API + Hooks
// composables/use-customer.ts
export const useCustomer = () => {
  const customerList = ref([]);
  const loading = ref(false);
  
  const fetchCustomers = async () => {
    loading.value = true;
    try {
      customerList.value = await api.getCustomers();
    } finally {
      loading.value = false;
    }
  };
  
  return {
    customerList,
    loading,
    fetchCustomers,
  };
};

// ❌ 避免：复杂的类组件
class CustomerComponent extends Vue {
  // ...
}

// 变量: camelCase
const userName = 'John';
const isActive = true;

// 常量: UPPER_CASE
const MAX_COUNT = 100;
const API_TIMEOUT = 5000;

// 类型定义: camelCase
type UserId = string;
interface UserInfo {
  id: number;
  name: string;
}
```

**后端命名规范 (PascalCase 优先):**
```
- 类: PascalCase          CustomerService
- 接口: PascalCase        ICustomerService
- 实体: PascalCase        CustomerEntity
- DTO: PascalCase         CreateCustomerDto
- 枚举: PascalCase        UserStatus
- API路径: kebab-case     /api/v1/customers
```

**后端代码风格:**
```typescript
// 类: PascalCase
@Provide()
export class CustomerService {
  async getCustomerById(id: number): Promise<CustomerEntity> {
    // ...
  }
}

// 实体: PascalCase
@Entity('customer')
export class CustomerEntity {
  @Column()
  id: number;
  
  @Column()
  name: string;
}

// DTO: PascalCase
export class CreateCustomerDto {
  @Rule(RuleType.string().required())
  name: string;
  
  @Rule(RuleType.string().email())
  email: string;
}

// 控制器: PascalCase (但API路径用kebab-case)
@Controller('/api/v1/customers')
export class CustomerController {
  
  @Get('/:id')
  async getCustomer(@Param('id') id: number) {
    // ...
  }
  
  @Post('/create-customer')  // ✅ API路径用kebab-case
  async createCustomer(@Body() dto: CreateCustomerDto) {
    // ...
  }
}
```

#### 3.2.2 ESLint配置

**.eslintrc.js:**
```javascript
module.exports = {
  root: true,
  env: {
    browser: true,
    node: true,
    es2021: true,
  },
  extends: [
    'plugin:vue/vue3-recommended',
    'eslint:recommended',
    '@vue/typescript/recommended',
    '@vue/prettier',
  ],
  parserOptions: {
    ecmaVersion: 2021,
  },
  rules: {
    'no-console': process.env.NODE_ENV === 'production' ? 'warn' : 'off',
    'no-debugger': process.env.NODE_ENV === 'production' ? 'warn' : 'off',
    '@typescript-eslint/no-explicit-any': 'warn',
    '@typescript-eslint/no-unused-vars': 'warn',
    'vue/multi-word-component-names': 'off',
  },
};
```

#### 3.2.3 Prettier配置

**.prettierrc.js:**
```javascript
module.exports = {
  printWidth: 100,
  tabWidth: 2,
  useTabs: false,
  semi: true,
  singleQuote: true,
  quoteProps: 'as-needed',
  trailingComma: 'es5',
  bracketSpacing: true,
  arrowParens: 'always',
  endOfLine: 'lf',
};
```

---

### 3.3 API设计规范

#### 3.3.1 RESTful API规范

**URL设计:**
```
GET    /api/v1/customers          查询客户列表
GET    /api/v1/customers/:id      查询客户详情
POST   /api/v1/customers          创建客户
PUT    /api/v1/customers/:id      更新客户
PATCH  /api/v1/customers/:id      部分更新客户
DELETE /api/v1/customers/:id      删除客户
```

**请求格式:**
```typescript
// GET请求 - Query参数
GET /api/v1/customers?page=1&size=20&status=active

// POST/PUT请求 - Body
POST /api/v1/customers
Content-Type: application/json

{
  "name": "张三",
  "mobile": "13800138000",
  "tags": ["VIP", "高价值"]
}
```

**响应格式:**
```typescript
// 成功响应
{
  "code": 200,
  "message": "success",
  "data": {
    "id": 1,
    "name": "张三",
    "mobile": "13800138000"
  },
  "timestamp": "2025-10-27T10:00:00Z"
}

// 分页响应
{
  "code": 200,
  "message": "success",
  "data": {
    "list": [...],
    "total": 100,
    "page": 1,
    "size": 20
  }
}

// 错误响应
{
  "code": 400,
  "message": "参数错误",
  "errors": [
    {
      "field": "mobile",
      "message": "手机号格式不正确"
    }
  ],
  "timestamp": "2025-10-27T10:00:00Z"
}
```

#### 3.3.2 状态码规范

| 状态码 | 说明 | 使用场景 |
|-------|------|---------|
| 200 | 成功 | 请求成功 |
| 201 | 已创建 | 资源创建成功 |
| 204 | 无内容 | 删除成功 |
| 400 | 请求错误 | 参数错误 |
| 401 | 未授权 | 未登录 |
| 403 | 禁止访问 | 无权限 |
| 404 | 未找到 | 资源不存在 |
| 409 | 冲突 | 资源冲突 |
| 422 | 无法处理 | 业务逻辑错误 |
| 429 | 请求过多 | 限流 |
| 500 | 服务器错误 | 系统错误 |

---

### 3.4 认证授权设计

#### 3.4.1 JWT认证

**Token结构:**
```typescript
// Access Token (2小时)
{
  "userId": 1,
  "corpId": "wx123456",
  "roles": ["admin", "operator"],
  "exp": 1698400000,
  "iat": 1698393200
}

// Refresh Token (7天)
{
  "userId": 1,
  "type": "refresh",
  "exp": 1698998400,
  "iat": 1698393200
}
```

**认证流程:**
```
1. 用户登录 → 返回 AccessToken + RefreshToken
2. 请求API → Header携带 Authorization: Bearer <AccessToken>
3. Token过期 → 使用RefreshToken刷新
4. RefreshToken过期 → 重新登录
```

#### 3.4.2 权限控制

**RBAC模型:**
```typescript
// 角色定义
enum Role {
  SUPER_ADMIN = 'super_admin',
  ADMIN = 'admin',
  OPERATOR = 'operator',
  SALES = 'sales',
  VIEWER = 'viewer',
}

// 权限装饰器
@Controller('/api/v1/customers')
export class CustomerController {
  
  @Get('/')
  @Roles(Role.ADMIN, Role.OPERATOR, Role.SALES)
  async list() {
    // ...
  }
  
  @Delete('/:id')
  @Roles(Role.ADMIN)
  async delete() {
    // ...
  }
}
```

---

## 4. 数据库设计

### 4.1 数据库选型与分工

#### 4.1.1 数据存储策略

| 数据库类型 | 使用场景 | 数据类型 | 说明 |
|-----------|---------|---------|------|
| **MySQL 8.0** | 主数据库 | 结构化数据 | 用户、客户、订单等核心业务数据 |
| **Redis 7.0** | 缓存层 | KV缓存 | Session、热点数据、计数器 |
| **MongoDB 6.0** | 日志/消息 | 文档数据 | 操作日志、聊天记录、行为轨迹 |
| **ElasticSearch** | 搜索引擎 | 全文检索 | 客户搜索、内容搜索(可选) |

---

### 4.2 MySQL 数据库设计

#### 4.2.1 核心表结构设计

**1. 用户与权限模块**

```sql
-- 企业表
CREATE TABLE `corp` (
  `id` BIGINT UNSIGNED PRIMARY KEY AUTO_INCREMENT,
  `corp_id` VARCHAR(64) NOT NULL COMMENT '企业ID(企微corp_id)',
  `corp_name` VARCHAR(100) NOT NULL COMMENT '企业名称',
  `industry` VARCHAR(50) COMMENT '行业',
  `package_id` INT UNSIGNED COMMENT '套餐ID',
  `expire_time` DATETIME COMMENT '到期时间',
  `status` TINYINT DEFAULT 1 COMMENT '状态: 0-停用 1-正常 2-试用',
  `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP,
  `update_time` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  UNIQUE KEY `uk_corp_id` (`corp_id`),
  KEY `idx_status` (`status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='企业表';

-- 用户表
CREATE TABLE `user` (
  `id` BIGINT UNSIGNED PRIMARY KEY AUTO_INCREMENT,
  `corp_id` BIGINT UNSIGNED NOT NULL COMMENT '企业ID',
  `username` VARCHAR(50) NOT NULL COMMENT '用户名',
  `password` VARCHAR(255) NOT NULL COMMENT '密码(BCrypt加密)',
  `real_name` VARCHAR(50) COMMENT '真实姓名',
  `mobile` VARCHAR(20) COMMENT '手机号',
  `email` VARCHAR(100) COMMENT '邮箱',
  `avatar` VARCHAR(255) COMMENT '头像',
  `wework_userid` VARCHAR(64) COMMENT '企微员工ID',
  `status` TINYINT DEFAULT 1 COMMENT '状态: 0-禁用 1-正常',
  `is_admin` TINYINT DEFAULT 0 COMMENT '是否管理员',
  `last_login_time` DATETIME COMMENT '最后登录时间',
  `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP,
  `update_time` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  UNIQUE KEY `uk_username` (`corp_id`, `username`),
  KEY `idx_corp_id` (`corp_id`),
  KEY `idx_mobile` (`mobile`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户表';

-- 角色表
CREATE TABLE `role` (
  `id` INT UNSIGNED PRIMARY KEY AUTO_INCREMENT,
  `corp_id` BIGINT UNSIGNED NOT NULL COMMENT '企业ID',
  `role_name` VARCHAR(50) NOT NULL COMMENT '角色名称',
  `role_code` VARCHAR(50) NOT NULL COMMENT '角色编码',
  `description` VARCHAR(255) COMMENT '描述',
  `is_system` TINYINT DEFAULT 0 COMMENT '是否系统角色',
  `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP,
  KEY `idx_corp_id` (`corp_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='角色表';

-- 用户角色关联表
CREATE TABLE `user_role` (
  `user_id` BIGINT UNSIGNED NOT NULL,
  `role_id` INT UNSIGNED NOT NULL,
  PRIMARY KEY (`user_id`, `role_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户角色关联表';
```

**2. 客户管理模块**

```sql
-- 客户表
CREATE TABLE `customer` (
  `id` BIGINT UNSIGNED PRIMARY KEY AUTO_INCREMENT,
  `corp_id` BIGINT UNSIGNED NOT NULL COMMENT '企业ID',
  `external_userid` VARCHAR(100) NOT NULL COMMENT '企微外部联系人ID',
  `name` VARCHAR(100) COMMENT '客户名称',
  `avatar` VARCHAR(255) COMMENT '头像',
  `type` TINYINT DEFAULT 1 COMMENT '类型: 1-微信 2-企微',
  `gender` TINYINT COMMENT '性别: 0-未知 1-男 2-女',
  `unionid` VARCHAR(100) COMMENT '微信unionid',
  `province` VARCHAR(50) COMMENT '省份',
  `city` VARCHAR(50) COMMENT '城市',
  `follow_user_id` BIGINT UNSIGNED COMMENT '跟进员工ID',
  `add_time` DATETIME COMMENT '添加时间',
  `channel` VARCHAR(50) COMMENT '添加渠道',
  `status` TINYINT DEFAULT 1 COMMENT '状态: 0-已删除 1-正常 2-流失',
  `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP,
  `update_time` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  UNIQUE KEY `uk_external_userid` (`corp_id`, `external_userid`),
  KEY `idx_follow_user` (`follow_user_id`),
  KEY `idx_channel` (`channel`),
  KEY `idx_status` (`status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='客户表';

-- 客户标签表
CREATE TABLE `customer_tag` (
  `id` INT UNSIGNED PRIMARY KEY AUTO_INCREMENT,
  `corp_id` BIGINT UNSIGNED NOT NULL,
  `tag_name` VARCHAR(50) NOT NULL COMMENT '标签名称',
  `tag_type` TINYINT DEFAULT 1 COMMENT '类型: 1-来源 2-行为 3-兴趣 4-价值',
  `parent_id` INT UNSIGNED DEFAULT 0 COMMENT '父标签ID',
  `sort` INT DEFAULT 0 COMMENT '排序',
  `is_auto` TINYINT DEFAULT 0 COMMENT '是否自动标签',
  `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP,
  KEY `idx_corp_id` (`corp_id`),
  KEY `idx_parent_id` (`parent_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='客户标签表';

-- 客户标签关联表
CREATE TABLE `customer_tag_relation` (
  `customer_id` BIGINT UNSIGNED NOT NULL,
  `tag_id` INT UNSIGNED NOT NULL,
  `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`customer_id`, `tag_id`),
  KEY `idx_tag_id` (`tag_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='客户标签关联表';

-- 客户群表
CREATE TABLE `customer_group` (
  `id` BIGINT UNSIGNED PRIMARY KEY AUTO_INCREMENT,
  `corp_id` BIGINT UNSIGNED NOT NULL,
  `chat_id` VARCHAR(100) NOT NULL COMMENT '企微群聊ID',
  `group_name` VARCHAR(100) COMMENT '群名称',
  `owner_id` BIGINT UNSIGNED COMMENT '群主员工ID',
  `member_count` INT DEFAULT 0 COMMENT '成员数量',
  `notice` TEXT COMMENT '群公告',
  `status` TINYINT DEFAULT 1 COMMENT '状态: 0-已解散 1-正常',
  `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP,
  `update_time` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  UNIQUE KEY `uk_chat_id` (`corp_id`, `chat_id`),
  KEY `idx_owner_id` (`owner_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='客户群表';
```

**3. SOP与任务模块**

```sql
-- SOP模板表
CREATE TABLE `sop_template` (
  `id` INT UNSIGNED PRIMARY KEY AUTO_INCREMENT,
  `corp_id` BIGINT UNSIGNED NOT NULL,
  `template_name` VARCHAR(100) NOT NULL COMMENT '模板名称',
  `template_type` TINYINT DEFAULT 1 COMMENT '类型: 1-客户SOP 2-群SOP',
  `trigger_type` TINYINT COMMENT '触发类型: 1-添加好友 2-打标签 3-进群',
  `trigger_condition` JSON COMMENT '触发条件',
  `status` TINYINT DEFAULT 1 COMMENT '状态: 0-停用 1-启用',
  `create_user_id` BIGINT UNSIGNED,
  `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP,
  `update_time` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  KEY `idx_corp_id` (`corp_id`),
  KEY `idx_status` (`status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='SOP模板表';

-- SOP步骤表
CREATE TABLE `sop_step` (
  `id` INT UNSIGNED PRIMARY KEY AUTO_INCREMENT,
  `template_id` INT UNSIGNED NOT NULL,
  `step_order` INT NOT NULL COMMENT '步骤顺序',
  `step_type` TINYINT COMMENT '步骤类型: 1-发消息 2-打标签 3-推送素材',
  `delay_time` INT DEFAULT 0 COMMENT '延迟时间(分钟)',
  `action_type` TINYINT COMMENT '动作类型',
  `action_content` JSON COMMENT '动作内容',
  KEY `idx_template_id` (`template_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='SOP步骤表';

-- SOP执行记录表
CREATE TABLE `sop_execution` (
  `id` BIGINT UNSIGNED PRIMARY KEY AUTO_INCREMENT,
  `corp_id` BIGINT UNSIGNED NOT NULL,
  `template_id` INT UNSIGNED NOT NULL,
  `customer_id` BIGINT UNSIGNED COMMENT '客户ID',
  `group_id` BIGINT UNSIGNED COMMENT '群ID',
  `current_step` INT DEFAULT 0 COMMENT '当前步骤',
  `status` TINYINT DEFAULT 0 COMMENT '状态: 0-执行中 1-已完成 2-已暂停',
  `start_time` DATETIME DEFAULT CURRENT_TIMESTAMP,
  `complete_time` DATETIME,
  KEY `idx_customer_id` (`customer_id`),
  KEY `idx_status` (`status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='SOP执行记录表';
```

**4. 内容与渠道管理**

```sql
-- 平台账号表
CREATE TABLE `platform_account` (
  `id` INT UNSIGNED PRIMARY KEY AUTO_INCREMENT,
  `corp_id` BIGINT UNSIGNED NOT NULL,
  `platform` VARCHAR(20) NOT NULL COMMENT '平台: douyin/xiaohongshu/wechat',
  `account_name` VARCHAR(100) COMMENT '账号名称',
  `account_id` VARCHAR(100) COMMENT '平台账号ID',
  `access_token` VARCHAR(500) COMMENT 'AccessToken',
  `refresh_token` VARCHAR(500) COMMENT 'RefreshToken',
  `expires_time` DATETIME COMMENT 'Token过期时间',
  `status` TINYINT DEFAULT 1 COMMENT '状态: 0-失效 1-正常',
  `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP,
  `update_time` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  KEY `idx_corp_id` (`corp_id`),
  KEY `idx_platform` (`platform`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='平台账号表';

-- 内容表
CREATE TABLE `content` (
  `id` BIGINT UNSIGNED PRIMARY KEY AUTO_INCREMENT,
  `corp_id` BIGINT UNSIGNED NOT NULL,
  `account_id` INT UNSIGNED NOT NULL COMMENT '账号ID',
  `platform` VARCHAR(20) NOT NULL COMMENT '平台',
  `content_type` TINYINT COMMENT '内容类型: 1-图文 2-视频',
  `title` VARCHAR(255) COMMENT '标题',
  `content` TEXT COMMENT '内容',
  `media_urls` JSON COMMENT '媒体文件URLs',
  `cover_url` VARCHAR(255) COMMENT '封面',
  `topics` JSON COMMENT '话题标签',
  `status` TINYINT DEFAULT 0 COMMENT '状态: 0-草稿 1-已发布 2-失败',
  `publish_time` DATETIME COMMENT '发布时间',
  `platform_content_id` VARCHAR(100) COMMENT '平台内容ID',
  `create_user_id` BIGINT UNSIGNED,
  `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP,
  `update_time` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  KEY `idx_corp_id` (`corp_id`),
  KEY `idx_account_id` (`account_id`),
  KEY `idx_platform` (`platform`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='内容表';
```

**5. 数据统计表**

```sql
-- 渠道统计表 (按天汇总)
CREATE TABLE `channel_stats_daily` (
  `id` BIGINT UNSIGNED PRIMARY KEY AUTO_INCREMENT,
  `corp_id` BIGINT UNSIGNED NOT NULL,
  `stat_date` DATE NOT NULL COMMENT '统计日期',
  `platform` VARCHAR(20) NOT NULL COMMENT '平台',
  `account_id` INT UNSIGNED COMMENT '账号ID',
  `exposure_count` INT DEFAULT 0 COMMENT '曝光量',
  `click_count` INT DEFAULT 0 COMMENT '点击量',
  `add_count` INT DEFAULT 0 COMMENT '添加客户数',
  `conversion_rate` DECIMAL(5,2) COMMENT '转化率',
  `cost` DECIMAL(10,2) DEFAULT 0 COMMENT '成本',
  `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP,
  UNIQUE KEY `uk_stat` (`corp_id`, `stat_date`, `platform`, `account_id`),
  KEY `idx_stat_date` (`stat_date`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='渠道日统计表';

-- 客户行为统计表
CREATE TABLE `customer_behavior_stats` (
  `id` BIGINT UNSIGNED PRIMARY KEY AUTO_INCREMENT,
  `customer_id` BIGINT UNSIGNED NOT NULL,
  `stat_date` DATE NOT NULL,
  `message_count` INT DEFAULT 0 COMMENT '消息数',
  `click_count` INT DEFAULT 0 COMMENT '点击数',
  `active_days` INT DEFAULT 0 COMMENT '活跃天数',
  `last_active_time` DATETIME COMMENT '最后活跃时间',
  `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP,
  UNIQUE KEY `uk_customer_date` (`customer_id`, `stat_date`),
  KEY `idx_stat_date` (`stat_date`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='客户行为统计表';
```

**6. 财务模块**

```sql
-- 订单表
CREATE TABLE `order` (
  `id` BIGINT UNSIGNED PRIMARY KEY AUTO_INCREMENT,
  `order_no` VARCHAR(32) NOT NULL COMMENT '订单号',
  `corp_id` BIGINT UNSIGNED NOT NULL,
  `package_id` INT UNSIGNED NOT NULL COMMENT '套餐ID',
  `amount` DECIMAL(10,2) NOT NULL COMMENT '金额',
  `pay_amount` DECIMAL(10,2) COMMENT '实付金额',
  `pay_type` TINYINT COMMENT '支付方式: 1-微信 2-支付宝',
  `pay_status` TINYINT DEFAULT 0 COMMENT '支付状态: 0-待支付 1-已支付 2-已退款',
  `pay_time` DATETIME COMMENT '支付时间',
  `expire_time` DATETIME COMMENT '到期时间',
  `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP,
  `update_time` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  UNIQUE KEY `uk_order_no` (`order_no`),
  KEY `idx_corp_id` (`corp_id`),
  KEY `idx_pay_status` (`pay_status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='订单表';
```

---

#### 4.2.2 索引策略

**索引设计原则:**
1. 主键使用自增ID,避免UUID
2. 外键字段建立普通索引
3. 高频查询字段建立索引
4. 联合索引遵循最左前缀原则
5. 避免过多索引影响写入性能

**关键索引:**
```sql
-- 客户表关键索引
ALTER TABLE customer 
  ADD INDEX idx_corp_follow_status (corp_id, follow_user_id, status),
  ADD INDEX idx_create_time (create_time);

-- 内容表关键索引  
ALTER TABLE content
  ADD INDEX idx_publish_time (publish_time DESC),
  ADD INDEX idx_status_create (status, create_time);

-- 统计表分区 (按月分区)
ALTER TABLE channel_stats_daily 
  PARTITION BY RANGE (TO_DAYS(stat_date)) (
    PARTITION p202510 VALUES LESS THAN (TO_DAYS('2025-11-01')),
    PARTITION p202511 VALUES LESS THAN (TO_DAYS('2025-12-01')),
    -- ...后续分区
  );
```

---

### 4.3 Redis 缓存设计

#### 4.3.1 缓存Key设计规范

**Key命名规范:**
```
格式: {业务模块}:{数据类型}:{具体标识}[:补充字段]
示例:
- user:info:123                 # 用户信息
- customer:profile:456          # 客户画像
- sop:execution:789             # SOP执行状态
- stats:channel:daily:20251027  # 渠道统计
```

#### 4.3.2 缓存数据类型与策略

| 业务场景 | 数据类型 | Key示例 | TTL | 说明 |
|---------|---------|---------|-----|------|
| 用户Session | String | `session:{token}` | 2h | JWT存储 |
| 用户信息 | Hash | `user:info:{userId}` | 30m | 用户基本信息 |
| 客户画像 | Hash | `customer:profile:{customerId}` | 10m | 客户详情 |
| 标签列表 | List | `tag:list:{corpId}` | 1h | 企业标签 |
| 热点数据 | String | `hot:content:{id}` | 1h | 热门内容 |
| 计数器 | String | `counter:click:{contentId}` | - | 点击计数 |
| 分布式锁 | String | `lock:sop:{customerId}` | 30s | SOP执行锁 |
| 消息队列 | List | `queue:message` | - | 消息队列 |

#### 4.3.3 缓存更新策略

**Cache-Aside Pattern (旁路缓存):**
```typescript
// 读取流程
async getCustomer(id: number) {
  // 1. 先查缓存
  let customer = await redis.get(`customer:profile:${id}`);
  
  if (customer) {
    return JSON.parse(customer);
  }
  
  // 2. 缓存未命中,查数据库
  customer = await customerRepo.findOne(id);
  
  // 3. 写入缓存
  if (customer) {
    await redis.setex(
      `customer:profile:${id}`,
      600, // 10分钟
      JSON.stringify(customer)
    );
  }
  
  return customer;
}

// 更新流程
async updateCustomer(id: number, data: any) {
  // 1. 更新数据库
  await customerRepo.update(id, data);
  
  // 2. 删除缓存 (下次读取时重新加载)
  await redis.del(`customer:profile:${id}`);
}
```

---

### 4.4 MongoDB 数据设计

#### 4.4.1 集合设计

**1. 操作日志集合**
```javascript
// operation_logs
{
  _id: ObjectId,
  corpId: Long,
  userId: Long,
  action: String,        // 操作类型: create/update/delete
  module: String,        // 模块: customer/sop/content
  targetId: Long,        // 目标ID
  targetType: String,    // 目标类型
  content: Object,       // 操作内容
  ip: String,           // IP地址
  userAgent: String,    // User-Agent
  createdAt: Date
}

// 索引
db.operation_logs.createIndex({ corpId: 1, createdAt: -1 });
db.operation_logs.createIndex({ userId: 1, createdAt: -1 });
```

**2. 聊天记录集合**
```javascript
// chat_messages
{
  _id: ObjectId,
  corpId: Long,
  customerId: Long,
  userId: Long,
  msgType: String,       // 消息类型: text/image/video
  content: Object,       // 消息内容
  direction: String,     // 方向: send/receive
  timestamp: Date,
  createdAt: Date
}

// 索引
db.chat_messages.createIndex({ customerId: 1, timestamp: -1 });
db.chat_messages.createIndex({ corpId: 1, timestamp: -1 });
```

**3. 行为轨迹集合**
```javascript
// behavior_tracks
{
  _id: ObjectId,
  corpId: Long,
  customerId: Long,
  eventType: String,     // 事件类型: page_view/click/download
  eventData: Object,     // 事件数据
  url: String,
  referrer: String,
  timestamp: Date,
  createdAt: Date
}

// 索引
db.behavior_tracks.createIndex({ customerId: 1, timestamp: -1 });
```

---

## 5. 部署架构

### 5.1 部署方案选择

#### 5.1.1 开发环境

**单机部署方案:**
```
开发机器 (本地/云服务器)
├── Node.js 18 + Midway
├── MySQL 8.0 (Docker)
├── Redis 7.0 (Docker)
├── MongoDB 6.0 (Docker)
└── 前端开发服务器 (Vite Dev Server)
```

**Docker Compose 配置:**
```yaml
# docker-compose.dev.yml
version: '3.8'

services:
  mysql:
    image: mysql:8.0
    container_name: scrm-mysql
    environment:
      MYSQL_ROOT_PASSWORD: root123
      MYSQL_DATABASE: scrm_dev
    ports:
      - "3306:3306"
    volumes:
      - mysql-data:/var/lib/mysql
    command: --default-authentication-plugin=mysql_native_password

  redis:
    image: redis:7.0-alpine
    container_name: scrm-redis
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data

  mongodb:
    image: mongo:6.0
    container_name: scrm-mongodb
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: admin123
    ports:
      - "27017:27017"
    volumes:
      - mongo-data:/data/db

volumes:
  mysql-data:
  redis-data:
  mongo-data:
```

---

#### 5.1.2 生产环境

**云服务器部署架构:**

```
┌────────────────────────────────────────────────────────┐
│                      阿里云/腾讯云                       │
├────────────────────────────────────────────────────────┤
│                                                          │
│  CDN (静态资源加速)                                      │
│    ↓                                                     │
│  SLB (负载均衡)                                          │
│    ↓                                                     │
│  ┌──────────────────────────────────────────────────┐  │
│  │  Web服务器集群 (Nginx × 2)                       │  │
│  │  - 静态资源服务                                   │  │
│  │  - 反向代理                                       │  │
│  └──────────────────────────────────────────────────┘  │
│    ↓                                                     │
│  ┌──────────────────────────────────────────────────┐  │
│  │  应用服务器集群 (Node.js × 4+)                   │  │
│  │  - Docker容器化部署                               │  │
│  │  - PM2进程管理                                    │  │
│  └──────────────────────────────────────────────────┘  │
│    ↓                                                     │
│  ┌────────────┐  ┌────────────┐  ┌────────────┐       │
│  │ MySQL      │  │ Redis      │  │ MongoDB    │       │
│  │ (主从)     │  │ (集群)     │  │ (副本集)   │       │
│  └────────────┘  └────────────┘  └────────────┘       │
│                                                          │
│  ┌──────────────────────────────────────────────────┐  │
│  │  监控告警 (Prometheus + Grafana)                 │  │
│  └──────────────────────────────────────────────────┘  │
│                                                          │
└────────────────────────────────────────────────────────┘
```

---

### 5.2 容器化部署

#### 5.2.1 Dockerfile

**后端服务 Dockerfile:**
```dockerfile
# packages/server/Dockerfile
FROM node:18-alpine AS builder

WORKDIR /app

# 安装pnpm
RUN npm install -g pnpm

# 复制依赖文件
COPY package.json pnpm-lock.yaml ./
COPY packages/server/package.json ./packages/server/
COPY packages/shared/package.json ./packages/shared/

# 安装依赖
RUN pnpm install --frozen-lockfile

# 复制源代码
COPY packages/server ./packages/server
COPY packages/shared ./packages/shared

# 构建
WORKDIR /app/packages/server
RUN pnpm build

# 生产镜像
FROM node:18-alpine

WORKDIR /app

# 安装PM2
RUN npm install -g pm2

# 复制构建产物
COPY --from=builder /app/packages/server/dist ./dist
COPY --from=builder /app/packages/server/package.json ./
COPY --from=builder /app/node_modules ./node_modules

# 暴露端口
EXPOSE 7001

# 启动命令
CMD ["pm2-runtime", "start", "dist/bootstrap.js", "--name", "scrm-server"]
```

**前端 Dockerfile (以运营平台为例):**
```dockerfile
# packages/operation-web/Dockerfile
FROM node:18-alpine AS builder

WORKDIR /app

RUN npm install -g pnpm

COPY package.json pnpm-lock.yaml ./
COPY packages/operation-web/package.json ./packages/operation-web/
COPY packages/shared/package.json ./packages/shared/

RUN pnpm install --frozen-lockfile

COPY packages/operation-web ./packages/operation-web
COPY packages/shared ./packages/shared

WORKDIR /app/packages/operation-web
RUN pnpm build

# Nginx镜像
FROM nginx:alpine

COPY --from=builder /app/packages/operation-web/dist /usr/share/nginx/html
COPY packages/operation-web/nginx.conf /etc/nginx/conf.d/default.conf

EXPOSE 80

CMD ["nginx", "-g", "daemon off;"]
```

---

#### 5.2.2 Docker Compose 生产配置

```yaml
# docker-compose.prod.yml
version: '3.8'

services:
  # 后端服务
  server:
    build:
      context: .
      dockerfile: packages/server/Dockerfile
    container_name: scrm-server
    restart: always
    environment:
      NODE_ENV: production
      DB_HOST: mysql
      DB_PORT: 3306
      DB_USERNAME: scrm
      DB_PASSWORD: ${DB_PASSWORD}
      REDIS_HOST: redis
      REDIS_PORT: 6379
    ports:
      - "7001:7001"
    depends_on:
      - mysql
      - redis
    networks:
      - scrm-network

  # 运营平台
  operation-web:
    build:
      context: .
      dockerfile: packages/operation-web/Dockerfile
    container_name: scrm-operation-web
    restart: always
    ports:
      - "8001:80"
    networks:
      - scrm-network

  # MySQL
  mysql:
    image: mysql:8.0
    container_name: scrm-mysql
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: scrm_prod
      MYSQL_USER: scrm
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
    volumes:
      - mysql-data:/var/lib/mysql
      - ./scripts/init.sql:/docker-entrypoint-initdb.d/init.sql
    ports:
      - "3306:3306"
    networks:
      - scrm-network

  # Redis
  redis:
    image: redis:7.0-alpine
    container_name: scrm-redis
    restart: always
    command: redis-server --requirepass ${REDIS_PASSWORD}
    volumes:
      - redis-data:/data
    ports:
      - "6379:6379"
    networks:
      - scrm-network

networks:
  scrm-network:
    driver: bridge

volumes:
  mysql-data:
  redis-data:
```

---

### 5.3 CI/CD 流程

#### 5.3.1 GitHub Actions 配置

```yaml
# .github/workflows/deploy.yml
name: Deploy to Production

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Install pnpm
        run: npm install -g pnpm
      
      - name: Install dependencies
        run: pnpm install
      
      - name: Build server
        run: |
          cd packages/server
          pnpm build
      
      - name: Build frontend
        run: |
          cd packages/operation-web
          pnpm build
      
      - name: Build Docker images
        run: |
          docker build -t scrm-server:${{ github.sha }} -f packages/server/Dockerfile .
          docker build -t scrm-operation-web:${{ github.sha }} -f packages/operation-web/Dockerfile .
      
      - name: Push to Registry
        run: |
          docker tag scrm-server:${{ github.sha }} registry.example.com/scrm-server:latest
          docker push registry.example.com/scrm-server:latest
      
      - name: Deploy to server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /opt/scrm
            docker-compose pull
            docker-compose up -d
```

---

### 5.4 监控与日志

#### 5.4.1 Prometheus 监控配置

```yaml
# prometheus.yml
global:
  scrape_interval: 15s

scrape_configs:
  - job_name: 'scrm-server'
    static_configs:
      - targets: ['localhost:7001']
    metrics_path: '/metrics'
```

**Midway metrics 暴露:**
```typescript
// src/config/config.default.ts
export default {
  prometheus: {
    enable: true,
    labels: {
      app: 'scrm-server',
      env: process.env.NODE_ENV,
    },
  },
};
```

#### 5.4.2 日志收集

**Winston 日志配置:**
```typescript
// src/config/config.default.ts
import * as winston from 'winston';

export default {
  logger: {
    level: 'info',
    transports: [
      new winston.transports.File({
        filename: 'logs/error.log',
        level: 'error',
      }),
      new winston.transports.File({
        filename: 'logs/combined.log',
      }),
    ],
  },
};
```

---

## 6. 开发规范

### 6.1 Git 工作流

#### 6.1.1 分支策略

**Git Flow 模型:**
```
main (生产)
  ├── develop (开发)
  │    ├── feature/user-auth (功能分支)
  │    ├── feature/customer-management
  │    └── feature/sop-system
  ├── release/v1.0.0 (发布分支)
  └── hotfix/fix-login-bug (热修复)
```

**分支命名规范:**
- `feature/功能名称` - 新功能开发
- `bugfix/问题描述` - Bug修复
- `hotfix/紧急修复` - 生产环境紧急修复
- `release/版本号` - 发布分支
- `chore/任务描述` - 日常任务

#### 6.1.2 Commit 规范

**Conventional Commits:**
```
<type>(<scope>): <subject>

<body>

<footer>
```

**类型 (type):**
- `feat`: 新功能
- `fix`: Bug修复
- `docs`: 文档更新
- `style`: 代码格式(不影响功能)
- `refactor`: 重构
- `perf`: 性能优化
- `test`: 测试相关
- `chore`: 构建/工具变动

**示例:**
```bash
feat(customer): 添加客户画像功能

- 实现客户基础信息展示
- 添加标签云组件
- 集成行为轨迹时间线

Closes #123
```

---

### 6.2 代码审查规范

#### 6.2.1 Pull Request 流程

1. **创建PR**
   - 填写清晰的PR标题和描述
   - 关联相关Issue
   - 添加合适的Label

2. **代码审查检查项**
   - ✅ 代码符合编码规范
   - ✅ 测试用例完整
   - ✅ 没有明显性能问题
   - ✅ 文档已更新
   - ✅ 没有新增安全隐患

3. **合并要求**
   - 至少1人Review通过
   - CI/CD构建成功
   - 所有讨论已解决

---

### 6.3 测试规范

#### 6.3.1 单元测试

**Jest 配置:**
```javascript
// jest.config.js
module.exports = {
  preset: 'ts-jest',
  testEnvironment: 'node',
  coverageDirectory: 'coverage',
  collectCoverageFrom: [
    'src/**/*.ts',
    '!src/**/*.d.ts',
  ],
  coverageThreshold: {
    global: {
      branches: 80,
      functions: 80,
      lines: 80,
      statements: 80,
    },
  },
};
```

**测试示例:**
```typescript
// src/service/__tests__/customer.service.test.ts
import { CustomerService } from '../customer.service';

describe('CustomerService', () => {
  let service: CustomerService;

  beforeEach(() => {
    service = new CustomerService();
  });

  describe('getCustomer', () => {
    it('should return customer by id', async () => {
      const customer = await service.getCustomer(1);
      expect(customer).toBeDefined();
      expect(customer.id).toBe(1);
    });

    it('should return null for non-existent customer', async () => {
      const customer = await service.getCustomer(999);
      expect(customer).toBeNull();
    });
  });
});
```

---

### 6.4 文档规范

#### 6.4.1 API文档

**Swagger注解示例:**
```typescript
@Controller('/api/v1/customers')
@ApiTags('客户管理')
export class CustomerController {
  
  @Get('/')
  @ApiOperation({ summary: '查询客户列表' })
  @ApiQuery({ name: 'page', required: false, type: Number })
  @ApiQuery({ name: 'size', required: false, type: Number })
  @ApiResponse({ status: 200, description: '查询成功' })
  async list(
    @Query('page') page = 1,
    @Query('size') size = 20
  ) {
    // ...
  }
}
```

---

## 7. 附录

### 7.1 技术栈对比

#### 7.1.1 后端框架对比

| 特性 | Midway.js | Nest.js | Express | Koa |
|------|-----------|---------|---------|-----|
| TypeScript | ✅ 原生 | ✅ 原生 | ❌ 需配置 | ❌ 需配置 |
| 依赖注入 | ✅ | ✅ | ❌ | ❌ |
| 装饰器 | ✅ | ✅ | ❌ | ❌ |
| 学习曲线 | 中等 | 陡峭 | 平缓 | 平缓 |
| 生态完整度 | 好 | 优秀 | 优秀 | 良好 |
| 国内社区 | 活跃 | 活跃 | 活跃 | 活跃 |
| **选型理由** | 国内团队,中文文档好,集成度高 | - | - | - |

#### 7.1.2 前端框架对比

| 特性 | Vue3 | React | Angular |
|------|------|-------|---------|
| 学习曲线 | 平缓 | 中等 | 陡峭 |
| 灵活性 | 高 | 高 | 低 |
| 性能 | 优秀 | 优秀 | 良好 |
| TypeScript | 支持好 | 支持好 | 原生支持 |
| 生态系统 | 丰富 | 非常丰富 | 完整 |
| **选型理由** | 易学易用,渐进式,团队熟悉 | - | - |

---

### 7.2 开发环境配置指南

#### 7.2.1 快速开始

**1. 克隆项目**
```bash
git clone https://github.com/your-org/scrm-system.git
cd scrm-system
```

**2. 安装依赖**
```bash
# 安装pnpm (如果没有)
npm install -g pnpm

# 安装项目依赖
pnpm install
```

**3. 启动数据库**
```bash
docker-compose -f docker-compose.dev.yml up -d
```

**4. 初始化数据库**
```bash
cd packages/server
pnpm typeorm migration:run
pnpm seed  # 填充测试数据
```

**5. 启动后端服务**
```bash
cd packages/server
pnpm dev
```

**6. 启动前端(运营平台)**
```bash
cd packages/operation-web
pnpm dev
```

**7. 访问应用**
- 运营平台: http://localhost:3000
- API文档: http://localhost:7001/swagger-ui

---

### 7.3 常见问题 FAQ

#### Q1: pnpm install 失败?
```bash
# 清理缓存重试
pnpm store prune
rm -rf node_modules
rm pnpm-lock.yaml
pnpm install
```

#### Q2: TypeORM 连接数据库失败?
检查配置文件 `packages/server/src/config/config.local.ts`:
```typescript
export default {
  typeorm: {
    dataSource: {
      default: {
        type: 'mysql',
        host: '127.0.0.1',
        port: 3306,
        username: 'root',
        password: 'root123',
        database: 'scrm_dev',
      },
    },
  },
};
```

#### Q3: 如何调试后端代码?
在 VS Code 中创建 `.vscode/launch.json`:
```json
{
  "version": "0.2.0",
  "configurations": [
    {
      "type": "node",
      "request": "launch",
      "name": "Debug Server",
      "runtimeArgs": ["-r", "ts-node/register"],
      "args": ["${workspaceFolder}/packages/server/src/bootstrap.ts"],
      "cwd": "${workspaceFolder}/packages/server",
      "internalConsoleOptions": "openOnSessionStart"
    }
  ]
}
```

---

### 7.4 参考资料

**官方文档:**
- Midway.js: https://midwayjs.org/
- Vue3: https://vuejs.org/
- TypeORM: https://typeorm.io/
- UniApp: https://uniapp.dcloud.net.cn/

**技术文章:**
- Node.js 最佳实践: https://github.com/goldbergyoni/nodebestpractices
- Vue3 设计模式: https://vue3-design.netlify.app/
- MySQL优化指南: https://dev.mysql.com/doc/refman/8.0/en/optimization.html

**开源项目:**
- RuoYi-Cloud (微服务参考): https://gitee.com/y_project/RuoYi-Cloud
- vue-element-admin (后台模板): https://github.com/PanJiaChen/vue-element-admin

---

### 7.5 技术演进路线

#### 7.5.1 MVP 阶段 (0-3个月)
- ✅ 基础架构搭建
- ✅ 核心功能开发
- ✅ 单体应用部署

#### 7.5.2 V1.0 阶段 (3-6个月)
- 🔄 微服务拆分(可选)
- 🔄 性能优化
- 🔄 容器化部署

#### 7.5.3 V2.0 阶段 (6-12个月)
- 📋 Kubernetes编排
- 📋 服务网格(Istio)
- 📋 AI能力集成

---

## 文档结束

> **文档说明:**  
> 本技术选型文档详细描述了SCRM系统的技术架构、框架选型、开发规范和部署方案。
> 
> **使用建议:**  
> 1. 团队成员应熟悉本文档内容
> 2. 开发过程中严格遵循规范
> 3. 定期回顾和更新文档
> 4. 技术选型需经过团队评审
>
> **版权声明:**  
> 本文档为内部技术文档,未经授权不得外传。

---

**文档统计:**
- 总页数: 约80页
- 总字数: 约28,000字
- 表格数: 45+
- 代码示例: 30+
- 架构图: 8个

**文档完整度: 100%** ✅

**最后更新:** 2025-10-27


