# 快速开始指南

> 本指南帮助你快速搭建和运行SCRM系统的开发环境

---

## ✅ 环境检查

在开始之前，确保你的环境满足以下要求：

### 必需环境
- **Node.js**: 18.x LTS 或更高版本
- **pnpm**: 8.x 或更高版本
- **Git**: 任意版本

### 可选环境（推荐安装）
- **Docker Desktop**: 用于运行MySQL/Redis/MongoDB/RabbitMQ
- **VS Code**: 推荐的IDE，配合插件使用更佳

---

## 🚀 快速开始

本文档将指导您如何启动 SCRM 系统的开发环境。

## 📋 环境要求

- **Node.js**: >= 18.0.0
- **pnpm**: >= 8.0.0
- **MySQL**: 8.0+
- **Redis**: 7.0+
- **Docker** (可选，用于快速启动数据库)

## 🚀 快速启动

### 1. 安装依赖

```bash
# 安装 pnpm (如果还没有安装)
npm install -g pnpm@8

# 进入项目目录
cd code

# 安装所有依赖
pnpm install
```

### 2. 启动数据库 (使用 Docker)

```bash
# 在 code 目录下执行
docker-compose up -d
```

这将启动以下服务：
- MySQL (端口 3306)
- Redis (端口 6379)
- MongoDB (端口 27017)
- RabbitMQ (端口 5672, 管理界面 15672)
- Prometheus (端口 9090)
- Grafana (端口 3100)

等待服务启动完成（约30秒），数据库会自动执行初始化脚本。

### 3. 配置环境变量

```bash
# 复制环境变量示例文件
cp services/gateway-service/.env.example services/gateway-service/.env
cp services/auth-service/.env.example services/auth-service/.env

# 根据需要修改配置
```

### 4. 启动后端服务

#### 方式一：启动所有服务

```bash
# 在 code 目录下
pnpm dev:service
```

#### 方式二：单独启动某个服务

```bash
# 启动网关服务
cd services/gateway-service
pnpm dev

# 新开终端，启动认证服务
cd services/auth-service
pnpm dev
```

### 5. 验证服务是否启动成功

访问以下地址检查服务状态：

- 网关服务健康检查: http://localhost:7000/health
- 认证服务健康检查: http://localhost:7001/health

## 📦 构建共享包

如果修改了共享包（shared-types, shared-utils等），需要重新构建：

```bash
# 在 code 目录下
cd packages/shared-types
pnpm build

cd ../shared-utils
pnpm build

cd ../shared-constants
pnpm build
```

或使用 Turbo 批量构建：

```bash
# 在 code 目录下
pnpm build
```

## 🧪 测试 API

### 测试登录接口

使用默认管理员账号（已通过数据库初始化脚本创建）：

```bash
curl -X POST http://localhost:7000/api/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "username": "admin",
    "password": "Admin@123"
  }'
```

成功返回示例：

```json
{
  "accessToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "refreshToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "user": {
    "id": 1,
    "username": "admin",
    "corpId": 1,
    "isAdmin": 1
  }
}
```

## 📝 开发工作流

### 创建新的微服务

1. 在 `services/` 目录下创建新服务目录
2. 复制 `auth-service` 的 `package.json` 和 `tsconfig.json`
3. 修改服务名称和端口
4. 创建 `src` 目录结构
5. 运行 `pnpm install`

### 代码规范

```bash
# 代码检查
pnpm lint

# 代码格式化
pnpm format

# 类型检查
pnpm type-check
```

## 🐛 常见问题

### 1. 数据库连接失败

**问题**: `Error: connect ECONNREFUSED 127.0.0.1:3306`

**解决方案**:
- 确保 Docker Compose 中的 MySQL 已启动：`docker-compose ps`
- 检查数据库连接配置：查看 `.env` 文件中的 `DB_HOST`, `DB_PORT` 等

### 2. Redis 连接失败

**问题**: `Error: connect ECONNREFUSED 127.0.0.1:6379`

**解决方案**:
- 确保 Redis 已启动：`docker-compose ps`
- 检查 Redis 配置

### 3. pnpm install 失败

**问题**: 依赖安装失败

**解决方案**:
```bash
# 清理缓存
pnpm store prune

# 删除 node_modules
rm -rf node_modules

# 重新安装
pnpm install
```

### 4. 端口被占用

**问题**: `Error: listen EADDRINUSE: address already in use :::7000`

**解决方案**:
- 查找占用端口的进程：`lsof -i :7000` (Mac/Linux) 或 `netstat -ano | findstr :7000` (Windows)
- 杀死进程或修改服务端口配置

## 📚 下一步

- 阅读 [开发计划表.md](../开发计划表.md) 了解整体开发规划
- 查看 [需求规格说明书](../mvp/需求规格说明书.md) 了解业务需求
- 查看各服务的 README 了解详细开发指南

## 💡 提示

- 使用 VSCode 的 Workspace 功能打开项目，可以获得更好的开发体验
- 推荐安装 ESLint、Prettier、TypeScript 相关插件
- 建议使用 Postman 或 Apifox 管理 API 测试

