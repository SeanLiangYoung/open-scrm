# 环境配置说明

## 快速开始

### 1. 创建环境配置文件

```bash
# 复制环境变量模板
cp .env.example .env

# 编辑配置文件，填入实际的配置信息
# Windows: notepad .env
# Linux/Mac: vim .env
```

### 2. 必需配置项

以下配置项必须在启动服务前配置：

#### 数据库配置
```env
DB_HOST=localhost
DB_PORT=3306
DB_USER=root
DB_PASSWORD=your_mysql_password
DB_DATABASE=open_scrm
```

#### Redis配置
```env
REDIS_HOST=localhost
REDIS_PORT=6379
```

#### 应用密钥（重要！）
```env
# 用于Cookie签名等安全功能，生产环境必须修改
APP_KEYS=your_strong_random_key_here
```

### 3. 可选配置项

以下配置项根据实际需求配置：

#### OSS配置（用于素材管理）
仅在使用素材管理服务时需要配置

#### 企业微信配置（用于企微集成）
仅在使用企业微信集成功能时需要配置

#### 支付配置（用于财务管理）
仅在使用支付功能时需要配置

## 配置优先级

1. **环境变量** - 优先级最高
2. **`.env` 文件** - 次优先级
3. **默认配置** - 在各服务的 `config.default.ts` 中定义

## 安全建议

### 生产环境配置

1. **修改所有默认密钥**
   - `APP_KEYS` - 应用密钥
   - `JWT_SECRET` - JWT密钥
   - 数据库密码
   - Redis密码（如果有）

2. **使用环境变量**
   ```bash
   # 推荐在生产环境使用环境变量而非.env文件
   export APP_KEYS="your_production_key"
   export JWT_SECRET="your_production_jwt_secret"
   ```

3. **不要提交 `.env` 文件到Git**
   - `.env` 已在 `.gitignore` 中
   - 仅提交 `.env.example` 模板

### 密钥生成

推荐使用以下方式生成随机密钥：

```bash
# Node.js
node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"

# OpenSSL
openssl rand -hex 32

# PowerShell
[Convert]::ToBase64String([Security.Cryptography.RandomNumberGenerator]::GetBytes(32))
```

## 服务端口分配

| 服务 | 端口 | 说明 |
|------|------|------|
| auth-service | 7000 | 认证授权服务 |
| gateway-service | 7001 | API网关 |
| customer-service | 7002 | 客户管理服务 |
| acquisition-service | 7003 | 获客服务 |
| operation-service | 7004 | 运营管理服务 |
| asset-service | 7005 | 素材管理服务 |
| message-service | 7006 | 消息管理服务 |
| integration-service | 7007 | 企微集成服务 |
| analytics-service | 7008 | 数据分析服务 |
| finance-service | 7009 | 财务管理服务 |

## 故障排查

### 问题1: 服务启动失败 - "Can't found config key 'config.keys'"

**解决方案：**
1. 确保 `.env` 文件存在
2. 确保 `APP_KEYS` 已配置
3. 重启服务

### 问题2: 数据库连接失败

**解决方案：**
1. 确认 MySQL 已启动
2. 检查数据库配置是否正确
3. 确认数据库已创建：`CREATE DATABASE open_scrm CHARACTER SET utf8mb4;`

### 问题3: Redis连接失败

**解决方案：**
1. 确认 Redis 已启动
2. 检查 Redis 配置是否正确
3. 测试连接：`redis-cli ping`

### 问题4: 脚本路径错误

**注意：** 所有运行脚本已移动到 `scripts/run/` 目录

**解决方案：**
```bash
# 正确的路径
.\scripts\run\start-all-services.ps1
# 或使用 pnpm 命令
pnpm run start:all
```

## 开发环境快速配置

```bash
# 1. 启动Docker服务（MySQL + Redis）
docker-compose up -d

# 2. 创建配置文件
cp .env.example .env

# 3. 编辑.env，修改以下必需项：
# APP_KEYS=your_dev_key
# DB_PASSWORD=root
# JWT_SECRET=your_dev_jwt_secret

# 4. 初始化数据库
mysql -u root -p < scripts/init-db.sql

# 5. 启动所有服务
pnpm run start:all
```

## 相关文档

- [快速开始](./快速开始.md)
- [脚本总览](./scripts/README.md)
- [运行脚本文档](./scripts/run/README.md)
- [Docker Compose配置](./docker-compose.yml)
- [数据库初始化脚本](./scripts/init-db.sql)

